name: Release builds (No Secrets)

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:

env:
  JAVA_VERSION: "17"
  # Disable Gradle Daemon to prevent locking/caching issues in CI
  GRADLE_OPTS: "-Dorg.gradle.daemon=false"

jobs:
  android-linux:
    name: Build Android and Linux
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Linux desktop deps
        run: |
          sudo apt-get update
          sudo apt-get install -y clang cmake ninja-build pkg-config libgtk-3-dev liblzma-dev rpm patchelf libmpv-dev mpv libgstreamer1.0-dev libgstreamer-plugins-base1.0-dev libsecret-1-dev libjsoncpp-dev

      - name: Set up Java ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          distribution: temurin # Changed from jetbrains to temurin for better CI stability
          java-version: ${{ env.JAVA_VERSION }}

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: "3.38.5"
          cache: true

      # 【Updated Step】Fixes gradle.properties AND patches settings.gradle.kts for 403 errors
      - name: Fix Android Build Config (Proxies & Repositories)
        run: |
          # 1. Clean gradle.properties
          if [ -f "android/gradle.properties" ]; then
            echo "Found android/gradle.properties, removing proxy settings..."
            sed -i '/systemProp/d' android/gradle.properties
            sed -i '/org.gradle.java.home/d' android/gradle.properties
          fi

          # 2. Patch settings.gradle.kts to fix 403 Forbidden errors
          # This forces google() to be the first repository checked, bypassing Maven Central blocks
          if [ -f "android/settings.gradle.kts" ]; then
            echo "Patching android/settings.gradle.kts to prioritize google() repo..."
            # Replaces 'repositories {' with 'repositories { google(); maven { url = uri("https://storage.googleapis.com/download.flutter.io") };'
            sed -i 's/repositories {/repositories { google(); maven { url = uri("https:\/\/storage.googleapis.com\/download.flutter.io") }; /g' android/settings.gradle.kts
            echo "Patched settings.gradle.kts content:"
            cat android/settings.gradle.kts
          fi

      - name: Build APKs
        run: |
          flutter build apk --release --split-per-abi

      - name: Collect APK artifacts
        run: |
          mkdir -p dist
          TAG="${GITHUB_REF_NAME}"
          # Copy artifacts if they exist
          if [ -f build/app/outputs/flutter-apk/app-arm64-v8a-release.apk ]; then
             cp build/app/outputs/flutter-apk/app-arm64-v8a-release.apk dist/guanbiziran-${TAG}-android-arm64-v8a.apk
          fi
          if [ -f build/app/outputs/flutter-apk/app-x86_64-release.apk ]; then
             cp build/app/outputs/flutter-apk/app-x86_64-release.apk dist/guanbiziran-${TAG}-android-x86_64.apk
          fi
          if [ -f build/app/outputs/flutter-apk/app-armeabi-v7a-release.apk ]; then
             cp build/app/outputs/flutter-apk/app-armeabi-v7a-release.apk dist/guanbiziran-${TAG}-android-armeabi-v7a.apk
          fi

      - name: Upload APK artifacts
        uses: actions/upload-artifact@v4
        with:
          name: android-apk
          path: dist/*.apk

      - name: Enable Linux desktop
        run: flutter config --enable-linux-desktop

      - name: Build Flutter for Linux
        run: flutter build linux

      - name: Package linux build output
        run: |
          TAG="${GITHUB_REF_NAME}"
          tar -zcvf guanbiziran-${TAG}-linux-amd64.tar.gz -C build/linux/x64/release/bundle .

      - name: Upload Linux artifacts
        uses: actions/upload-artifact@v4
        with:
          name: linux
          path: |
            guanbiziran-*.tar.gz

  windows:
    name: Build Windows
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: true

      - name: Enable Windows desktop
        shell: pwsh
        run: flutter config --enable-windows-desktop

      - name: Pub get
        shell: pwsh
        run: flutter pub get

      - name: Build Windows
        shell: pwsh
        run: flutter build windows --release

      - name: Zip Windows build
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          New-Item -ItemType Directory -Force -Path dist | Out-Null
          $tag = $env:GITHUB_REF_NAME
          $src = Join-Path build windows\x64\runner\Release
          $zip = Join-Path dist ("guanbiziran-$tag-windows-x64.zip")
          Compress-Archive -Path "$src\*" -DestinationPath $zip -Force

      - name: Upload Windows artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows
          path: |
            dist/*.zip
          if-no-files-found: warn

  release:
    name: Create draft GitHub Release
    runs-on: ubuntu-latest
    needs: [android-linux, windows]
    permissions: write-all
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: "*"
          merge-multiple: true

      - name: Create draft release and upload assets
        uses: softprops/action-gh-release@v2
        with:
          draft: true
          name: ${{ github.ref_name }}
          tag_name: ${{ github.ref_name }}
          files: |
            **/*.apk
            **/*.zip
            **/*.tar.gz